{{
  config(
    materialized='table'
  )
}}

WITH stg_events AS (
  SELECT
    *
  FROM {{ source('stg_postgres', 'stg_postgres__events') }}
)

SELECT
  SESSION_ID,
  USER_ID,
  SUM(CASE WHEN EVENT_TYPE = 'page_view' THEN 1 ELSE 0 END) AS NUM_PAGE_VIEWS,
  SUM(CASE WHEN EVENT_TYPE = 'add_to_cart' THEN 1 ELSE 0 END) AS NUM_ADD_TO_CART,
  SUM(CASE WHEN EVENT_TYPE = 'checkout' THEN 1 ELSE 0 END) AS NUM_CHECKOUT,
  SUM(CASE WHEN EVENT_TYPE = 'package_shipped' THEN 1 ELSE 0 END) AS NUM_PACKAGE_SHIPPED,
  MIN(CREATED_AT) AS SESSION_STARTED_TIME,
  MAX(CREATED_AT) AS SESSION_ENDED_TIME,
  MAX(CASE WHEN EVENT_TYPE = 'checkout' THEN CREATED_AT ELSE NULL END) AS CHECKOUT_TIME,
  MAX(CASE WHEN EVENT_TYPE = 'package_shipped' THEN CREATED_AT ELSE NULL END) AS SHIPPED_TIME,
  ROUND(DATEDIFF(seconds, SESSION_STARTED_TIME, SESSION_ENDED_TIME) / 60, 2) AS SESSION_DURATION_TOTAL_MINUTES,
  ROUND(DATEDIFF(seconds, CHECKOUT_TIME, SHIPPED_TIME) / 60, 2) AS SHIPPING_DURATION_MINUTES,
  SESSION_DURATION_TOTAL_MINUTES - NVL(SHIPPING_DURATION_MINUTES, 0) AS PRE_CHECKOUT_DURATION_MINUTES
FROM stg_events
GROUP BY 1,2
{{
  config(
    materialized='table'
  )
}}

WITH stg_events AS (
  SELECT
    *
  FROM {{ ref('stg_postgres__events') }}
)

SELECT
  SESSION_ID,
  USER_ID,
{{ postgres__agg_event_types() }}
  MIN(CREATED_AT) AS SESSION_STARTED_TIME,
  MAX(CREATED_AT) AS SESSION_ENDED_TIME,
  MAX(CASE WHEN EVENT_TYPE = 'checkout' THEN CREATED_AT ELSE NULL END) AS CHECKOUT_TIME,
  MAX(CASE WHEN EVENT_TYPE = 'package_shipped' THEN CREATED_AT ELSE NULL END) AS SHIPPED_TIME,
  ROUND(DATEDIFF(seconds, SESSION_STARTED_TIME, SESSION_ENDED_TIME) / 60, 2) AS SESSION_DURATION_TOTAL_MINUTES,
  ROUND(DATEDIFF(seconds, CHECKOUT_TIME, SHIPPED_TIME) / 60, 2) AS SHIPPING_DURATION_MINUTES,
  SESSION_DURATION_TOTAL_MINUTES - NVL(SHIPPING_DURATION_MINUTES, 0) AS PRE_CHECKOUT_DURATION_MINUTES
FROM stg_events
GROUP BY 1,2